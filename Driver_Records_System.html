<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Driver Records</title>
<style>
body {
font-family: 'Segoe UI', Tahoma, sans-serif;
background: #f4f7f5;
padding: 30px;
color: #1f2933;
}
h1 {
color: #0b3d2e;
border-bottom: 4px solid #1f7a4d;
padding-bottom: 10px;
}
h2 { color: #0b3d2e; margin-top: 30px; }
.form-section {
display: flex;
gap: 20px;
align-items: flex-start;
margin-bottom: 30px;
}
form {
background: #ffffff;
padding: 20px;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.08);
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 15px;
flex: 1;
max-width: 700px;
}
.sidebar {
display: flex;
flex-direction: column;
gap: 20px;
min-width: 180px;
}
.record-counter {
background: #ffffff;
padding: 0;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.08);
text-align: center;
overflow: hidden;
}
.record-counter h3 {
margin: 0;
padding: 10px;
background: #0b3d2e;
color: #ffffff;
font-size: 0.9rem;
text-transform: uppercase;
letter-spacing: 0.05em;
}
.record-counter .count {
font-size: 2.5rem;
font-weight: bold;
color: #1f7a4d;
margin: 20px 0 10px 0;
}
.record-counter .label {
font-size: 0.85rem;
color: #666;
margin-bottom: 20px;
}
.import-export-box {
background: #ffffff;
padding: 15px;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.import-export-box h3 {
margin: 0 0 12px 0;
color: #0b3d2e;
font-size: 0.9rem;
text-transform: uppercase;
letter-spacing: 0.05em;
text-align: center;
}
.csv-buttons {
display: flex;
flex-direction: column;
gap: 8px;
}
.csv-buttons button {
padding: 10px 15px;
font-size: 0.85rem;
background: #1f7a4d;
color: #ffffff;
border: none;
border-radius: 4px;
cursor: pointer;
width: 100%;
}
.csv-buttons button:hover {
background: #155c3a;
}
label { font-weight: 600; font-size: 0.9rem; }
input, select {
padding: 8px;
border-radius: 4px;
border: 1px solid #cbd5d6;
}
button {
grid-column: span 2;
background: #1f7a4d;
color: #ffffff;
border: none;
padding: 12px;
font-size: 1rem;
border-radius: 4px;
cursor: pointer;
}
button:hover { background: #155c3a; }
table {
width: 100%;
border-collapse: collapse;
background: #ffffff;
box-shadow: 0 4px 12px rgba(0,0,0,0.08);
margin-bottom: 20px;
}
th, td {
padding: 10px;
border-bottom: 1px solid #e2e8f0;
text-align: left;
}
td {
cursor: pointer;
user-select: none;
}
td:hover {
background: #e6f7ed;
}
th {
background: #0b3d2e;
color: #ffffff;
text-transform: uppercase;
font-size: 0.75rem;
letter-spacing: 0.05em;
position: relative;
user-select: none;
padding: 0;
vertical-align: middle;
height: 50px;
}

th .header-content {
display: flex;
align-items: center;
justify-content: space-between;
padding: 8px 10px;
gap: 8px;
height: 100%;
}

th .header-label {
flex-shrink: 0;
}

th .filter-select {
flex: 1;
min-width: 0;
background: rgba(255, 255, 255, 0.95);
color: #1f2933;
border: 1px solid #cbd5d6;
border-radius: 3px;
padding: 4px 6px;
font-size: 0.7rem;
cursor: pointer;
}

th .filter-select:hover {
background: #ffffff;
}

th .filter-select:focus {
outline: 2px solid #1f7a4d;
outline-offset: 1px;
}

th .sort-arrows {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
cursor: pointer;
user-select: none;
margin-left: 4px;
line-height: 0.7;
height: 100%;
}

th .sort-arrows:hover {
opacity: 0.8;
}

th .sort-arrow {
font-size: 0.6rem;
opacity: 0.5;
}

th .sort-arrow.active {
opacity: 1;
color: #ffd700;
}

th.actions-header {
padding: 10px;
}

tr:hover { background: #f0fdf4; }
tr.duplicate-driver { 
background-color: #ff4444 !important;
color: #ffffff;
font-weight: 600;
}
tr.duplicate-driver td {
border-bottom: 2px solid #cc0000;
}
tr.duplicate-driver:hover {
background-color: #ff6666 !important;
}
tr.duplicate-driver td:hover {
background-color: #ff8888 !important;
}
.actions-btn {
background: #1f7a4d;
color: white;
border: none;
padding: 5px 10px;
margin: 0 2px;
border-radius: 3px;
cursor: pointer;
font-size: 0.8rem;
}
.actions-btn.delete {
background: #dc2626;
}
.actions-btn.link {
background: #2563eb;
padding: 5px 8px;
}
.actions-btn:hover {
opacity: 0.8;
}
tr.duplicate-driver .actions-btn {
background: #ffffff;
color: #ff4444;
border: 2px solid #ffffff;
}
tr.duplicate-driver .actions-btn.delete {
background: #ffffff;
color: #dc2626;
}
tr.duplicate-driver .actions-btn.link {
background: #ffffff;
color: #2563eb;
}
.modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.5);
z-index: 1000;
}
.modal.active {
display: flex;
justify-content: center;
align-items: center;
}
.modal-content {
background: white;
padding: 30px;
border-radius: 8px;
box-shadow: 0 4px 20px rgba(0,0,0,0.3);
max-width: 600px;
width: 90%;
}
.modal-content h3 {
margin-top: 0;
color: #0b3d2e;
}
.modal-form {
display: grid;
grid-template-columns: 1fr;
gap: 15px;
}
.modal-buttons {
display: flex;
gap: 10px;
margin-top: 20px;
}
.modal-buttons button {
flex: 1;
padding: 10px;
}
.modal-buttons .cancel {
background: #6b7280;
}

.clear-filters-btn {
background: #dc2626;
color: white;
border: none;
padding: 10px 20px;
border-radius: 4px;
cursor: pointer;
font-size: 0.85rem;
display: block;
width: 100%;
}

.clear-filters-btn:hover {
background: #b91c1c;
}

.duplicate-checkbox-container {
display: flex;
align-items: center;
gap: 6px;
}

.duplicate-checkbox-container input[type="checkbox"] {
cursor: pointer;
width: 16px;
height: 16px;
}

.duplicate-checkbox-container label {
cursor: pointer;
font-size: 0.75rem;
font-weight: 600;
margin: 0;
}

optgroup {
font-weight: bold;
font-style: normal;
color: #0b3d2e;
}

optgroup option {
font-weight: normal;
padding-left: 10px;
}

.separator-option {
font-size: 0.7rem;
text-align: center;
background: #e2e8f0;
color: #666;
font-style: italic;
}

.toast {
position: fixed;
bottom: 30px;
right: 30px;
background: #1f7a4d;
color: white;
padding: 12px 20px;
border-radius: 4px;
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
z-index: 2000;
font-size: 0.9rem;
opacity: 0;
transform: translateY(20px);
transition: opacity 0.3s, transform 0.3s;
}

.toast.show {
opacity: 1;
transform: translateY(0);
}
</style>
</head>
<body>
<h1>Driver Records System</h1>

<div class="form-section">
<form id="driverForm">
<label>First Name*</label>
<input id="firstName" required />
<label>Middle Name</label>
<input id="middleName" />
<label>Last Name*</label>
<input id="lastName" required />
<label>License #*</label>
<input id="license" required />
<label>Company</label>
<select id="companySelect">
<option value="">Select or type new...</option>
</select>
<label>Or Enter New Company</label>
<input id="companyInput" placeholder="e.g., ABC Co, XYZ Inc" />
<label>Date Entered</label>
<input id="dateEntered" type="date" />
<button type="submit">Add Driver</button>
</form>

<div class="sidebar">
<div class="record-counter">
<h3>Total Records</h3>
<div class="count" id="recordCount">0</div>
<div class="label">Drivers</div>
</div>
<div class="import-export-box">
<h3>Import/Export</h3>
<div class="csv-buttons">
<button id="exportCSV">Export CSV</button>
<label for="importCSV" style="margin:0; cursor:pointer;">
<input type="file" id="importCSV" accept=".csv" style="display:none;" />
<button type="button" onclick="document.getElementById('importCSV').click(); return false;">Import CSV</button>
</label>
</div>
</div>
<button class="clear-filters-btn" id="clearFiltersBtn">Clear All Filters</button>
</div>
</div>

<table id="driverTable">
<thead>
<tr>
<th>
<div class="header-content">
<span class="header-label">First</span>
<select class="filter-select" id="filterFirstName">
<option value="">All</option>
</select>
<div class="sort-arrows" data-column="0">
<span class="sort-arrow up">▲</span>
<span class="sort-arrow down">▼</span>
</div>
</div>
</th>
<th>
<div class="header-content">
<span class="header-label">Middle</span>
<select class="filter-select" id="filterMiddleName">
<option value="">All</option>
</select>
<div class="sort-arrows" data-column="1">
<span class="sort-arrow up">▲</span>
<span class="sort-arrow down">▼</span>
</div>
</div>
</th>
<th>
<div class="header-content">
<span class="header-label">Last</span>
<select class="filter-select" id="filterLastName">
<option value="">All</option>
</select>
<div class="sort-arrows" data-column="2">
<span class="sort-arrow up">▲</span>
<span class="sort-arrow down">▼</span>
</div>
</div>
</th>
<th>
<div class="header-content">
<span class="header-label">License</span>
<select class="filter-select" id="filterLicense">
<option value="">All</option>
</select>
<div class="sort-arrows" data-column="3">
<span class="sort-arrow up">▲</span>
<span class="sort-arrow down">▼</span>
</div>
</div>
</th>
<th>
<div class="header-content">
<span class="header-label">Company</span>
<select class="filter-select" id="filterCompany">
<option value="">All</option>
</select>
<div class="sort-arrows" data-column="4">
<span class="sort-arrow up">▲</span>
<span class="sort-arrow down">▼</span>
</div>
</div>
</th>
<th>
<div class="header-content">
<span class="header-label">Driver ID</span>
<select class="filter-select" id="filterDriverID">
<option value="">All</option>
</select>
<div class="sort-arrows" data-column="5">
<span class="sort-arrow up">▲</span>
<span class="sort-arrow down">▼</span>
</div>
</div>
</th>
<th>
<div class="header-content">
<span class="header-label">Date</span>
<select class="filter-select" id="filterDate">
<option value="">All</option>
</select>
<div class="sort-arrows" data-column="6">
<span class="sort-arrow up">▲</span>
<span class="sort-arrow down">▼</span>
</div>
</div>
</th>
<th class="actions-header">
<div class="header-content">
<span class="header-label">Actions</span>
<div class="duplicate-checkbox-container">
<input type="checkbox" id="showDuplicatesOnly" />
<label for="showDuplicatesOnly">Duplicates</label>
</div>
</div>
</th>
</tr>
</thead>
<tbody id="driverBody"></tbody>
</table>

<!-- Edit Modal -->
<div id="editModal" class="modal">
<div class="modal-content">
<h3>Edit Driver</h3>
<form id="editForm" class="modal-form">
<label>First Name*</label>
<input id="editFirstName" required />
<label>Middle Name</label>
<input id="editMiddleName" />
<label>Last Name*</label>
<input id="editLastName" required />
<label>License #*</label>
<input id="editLicense" required />
<label>Companies (comma-separated)</label>
<input id="editCompany" />
<label>Date Entered (leave blank to keep current)</label>
<input id="editDateEntered" type="date" />
<div class="modal-buttons">
<button type="submit">Save</button>
<button type="button" class="cancel" onclick="closeEditModal()">Cancel</button>
</div>
</form>
</div>
</div>

<script>
const form = document.getElementById('driverForm');
const firstName = document.getElementById('firstName');
const middleName = document.getElementById('middleName');
const lastName = document.getElementById('lastName');
const companySelect = document.getElementById('companySelect');
const companyInput = document.getElementById('companyInput');
const dateEnteredInput = document.getElementById('dateEntered');
const tbody = document.getElementById('driverBody');

const editFirstName = document.getElementById('editFirstName');
const editMiddleName = document.getElementById('editMiddleName');
const editLastName = document.getElementById('editLastName');
const editLicense = document.getElementById('editLicense');
const editCompany = document.getElementById('editCompany');
const editDateEntered = document.getElementById('editDateEntered');

const filterFirstName = document.getElementById('filterFirstName');
const filterMiddleName = document.getElementById('filterMiddleName');
const filterLastName = document.getElementById('filterLastName');
const filterLicense = document.getElementById('filterLicense');
const filterCompany = document.getElementById('filterCompany');
const filterDriverID = document.getElementById('filterDriverID');
const filterDate = document.getElementById('filterDate');
const showDuplicatesOnly = document.getElementById('showDuplicatesOnly');
const clearFiltersBtn = document.getElementById('clearFiltersBtn');

let drivers = [];
let editingIndex = -1;
let sortState = { column: null, asc: true };

/* ---------------- STORAGE ---------------- */
function saveDrivers() {
localStorage.setItem('drivers', JSON.stringify(drivers));
}
function loadDrivers() {
const stored = localStorage.getItem('drivers');
drivers = stored ? JSON.parse(stored) : [];
}

/* ---------------- DRIVER ID GENERATION ---------------- */
function generateDriverID(first, middle, last, license) {
const f = (first || '').trim();
const m = (middle || '').trim();
const l = (last || '').trim();
const lic = (license || '').trim();

if (m) {
// If middle name exists: first initial + middle initial + last initial + license
return `${f[0] || ''}${m[0] || ''}${l[0] || ''}${lic}`.toUpperCase();
} else {
// If no middle name: first initial + last initial + last initial + license
return `${f[0] || ''}${l[0] || ''}${l[0] || ''}${lic}`.toUpperCase();
}
}

/* ---------------- CSV IMPORT/EXPORT ---------------- */
document.getElementById('exportCSV').addEventListener('click', () => {
const header = 'First Name,Middle Name,Last Name,License #,Companies,Driver ID,Date Entered\n';
const rows = drivers.map(d => {
return `"${d.first}","${d.middle}","${d.last}","${d.license}","${d.companies.join('; ')}","${d.driverID}","${d.dateEntered}"`;
}).join('\n');
const blob = new Blob([header + rows], { type: 'text/csv' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'drivers.csv';
a.click();
});

document.getElementById('importCSV').addEventListener('change', e => {
const file = e.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = evt => {
const text = evt.target.result;
const lines = text.split('\n').filter(l => l.trim());
lines.slice(1).forEach(line => {
const match = line.match(/(?:\"([^\"]*)\"|([^\",]*))/g);
if (!match || match.length < 4) return;
const cells = match.map(c => c.replace(/^"|"$/g, '').trim());
const [first, middle, last, license, companiesStr] = cells;
const companies = normalizeCompanies((companiesStr || '').split(/[;,]/));
const dateEntered = cells[6] || new Date().toLocaleDateString();
drivers.push({
first: first.toUpperCase(), 
middle: middle.toUpperCase(), 
last: last.toUpperCase(), 
license: license.toUpperCase(), 
companies,
driverID: generateDriverID(first.toUpperCase(), middle.toUpperCase(), last.toUpperCase(), license.toUpperCase()),
dateEntered
});
});
saveDrivers();
renderTable();
updateCompanyDropdown();
populateFilters();
e.target.value = '';
};
reader.readAsText(file);
});

/* ---------------- COMPANY HELPERS ---------------- */
function normalizeCompanies(arr) {
return [...new Set(arr.map(c => c.trim()).filter(Boolean))];
}
function updateCompanyDropdown() {
const all = drivers.flatMap(d => d.companies);
const unique = normalizeCompanies(all);
companySelect.innerHTML = '<option value="">Select or type new...</option>';
unique.forEach(c => {
const opt = document.createElement('option');
opt.value = c;
opt.textContent = c;
companySelect.appendChild(opt);
});
}

/* ---------------- NAME SPLITTING ---------------- */
function splitName(fullName) {
const parts = fullName.trim().split(/\s+/);
if (parts.length === 1) return { first: parts[0], middle: '', last: '' };
if (parts.length === 2) return { first: parts[0], middle: '', last: parts[1] };
return { first: parts[0], middle: parts.slice(1, -1).join(' '), last: parts[parts.length - 1] };
}

/* ---------------- CLIPBOARD ---------------- */
function copyToClipboard(text) {
navigator.clipboard.writeText(text).then(() => {
showToast(`Copied: ${text}`);
}).catch(() => {
showToast('Copy failed');
});
}

function showToast(message) {
// Remove any existing toast
const existingToast = document.querySelector('.toast');
if (existingToast) {
existingToast.remove();
}

// Create new toast
const toast = document.createElement('div');
toast.className = 'toast';
toast.textContent = message;
document.body.appendChild(toast);

// Show toast
setTimeout(() => toast.classList.add('show'), 10);

// Hide and remove toast after 2 seconds
setTimeout(() => {
toast.classList.remove('show');
setTimeout(() => toast.remove(), 300);
}, 2000);
}

/* ---------------- RENDER TABLE ---------------- */
function renderTable() {
tbody.innerHTML = '';

const companyMap = {};
drivers.forEach(d => {
if (!companyMap[d.driverID]) companyMap[d.driverID] = new Set();
d.companies.forEach(c => companyMap[d.driverID].add(c));
});

drivers.forEach((d, i) => {
const tr = document.createElement('tr');
const isDuplicate = companyMap[d.driverID].size > 1;
if (isDuplicate) tr.classList.add('duplicate-driver');

const cells = [
{ content: d.first, raw: d.first },
{ content: d.middle, raw: d.middle },
{ content: d.last, raw: d.last },
{ content: d.license, raw: d.license },
{ content: d.companies.join(', '), raw: d.companies.join(', ') },
{ content: d.driverID, raw: d.driverID },
{ content: d.dateEntered, raw: d.dateEntered }
];

cells.forEach(cell => {
const td = document.createElement('td');
td.textContent = cell.content;
td.dataset.raw = cell.raw;
td.dataset.index = i;
td.addEventListener('click', e => { if (e.detail === 1) copyToClipboard(td.dataset.raw); });
td.addEventListener('dblclick', () => {
// Copy in format: FIRSTNAME MIDDLENAME LASTNAME 3DIGITLICENCE
// If middle name is blank, use: FIRSTNAME LASTNAME 3DIGITLICENCE
const last3Digits = d.license.slice(-3);
const record = d.middle 
  ? `${d.first} ${d.middle} ${d.last} ${last3Digits}`
  : `${d.first} ${d.last} ${last3Digits}`;
copyToClipboard(record);
});
tr.appendChild(td);
});

// Build PDF link path
const safeName = [d.first, d.middle, d.last].filter(Boolean).join(' ');
const pdfFileName = `${safeName} ${d.license.slice(-3)}.pdf`;
const pdfPath = `file:///S:/Woods/Private/HARVESTING/LOG HAUL/LOG HAUL ADMIN/2025-2026/2025-2026 DRIVER FILING CABINET/${encodeURIComponent(pdfFileName)}`;

const actionsTd = document.createElement('td');
actionsTd.innerHTML = `
<button class="actions-btn" data-index="${i}">Edit</button>
<button class="actions-btn delete" data-index="${i}">Delete</button>
<button class="actions-btn link" data-pdf="${pdfPath}" title="Open PDF: ${pdfFileName}">PDF</button>
`;
actionsTd.style.cursor = 'default';
tr.appendChild(actionsTd);
tbody.appendChild(tr);
});

document.querySelectorAll('.actions-btn:not(.delete):not(.link)').forEach(btn => {
btn.addEventListener('click', () => editDriver(parseInt(btn.getAttribute('data-index'))));
});

document.querySelectorAll('.actions-btn.delete').forEach(btn => {
btn.addEventListener('click', () => deleteDriver(parseInt(btn.getAttribute('data-index'))));
});

// PDF link buttons
document.querySelectorAll('.actions-btn.link').forEach(btn => {
btn.addEventListener('click', () => {
window.open(btn.getAttribute('data-pdf'), '_blank');
});
});

document.getElementById('recordCount').textContent = drivers.length;
updateSortArrows();
}

/* ---------------- ADD DRIVER ---------------- */
form.addEventListener('submit', e => {
e.preventDefault();

let first = firstName.value.trim().toUpperCase();
let middle = middleName.value.trim().toUpperCase();
let last = lastName.value.trim().toUpperCase();
if (first.includes(' ') && !last) {
const split = splitName(first);
first = split.first;
middle = middle || split.middle;
last = split.last;
}

const license = document.getElementById('license').value.trim().toUpperCase();
let companyValue = companySelect.value || companyInput.value;
const companies = normalizeCompanies(companyValue.split(','));
const dateEntered = dateEnteredInput.value
? new Date(dateEnteredInput.value).toLocaleDateString()
: new Date().toLocaleDateString();

drivers.push({
first, middle, last, license, companies,
driverID: generateDriverID(first, middle, last, license),
dateEntered
});

saveDrivers();
renderTable();
form.reset();
companySelect.value = '';
updateCompanyDropdown();
populateFilters();
applyFilters();
});

/* ---------------- EDIT DRIVER ---------------- */
function editDriver(index) {
editingIndex = index;
const d = drivers[index];
editFirstName.value = d.first;
editMiddleName.value = d.middle;
editLastName.value = d.last;
editLicense.value = d.license;
editCompany.value = d.companies.join(', ');
editDateEntered.value = '';
document.getElementById('editModal').classList.add('active');
}

document.getElementById('editForm').addEventListener('submit', e => {
e.preventDefault();
const d = drivers[editingIndex];
d.first = editFirstName.value.trim().toUpperCase();
d.middle = editMiddleName.value.trim().toUpperCase();
d.last = editLastName.value.trim().toUpperCase();
d.license = editLicense.value.trim().toUpperCase();
d.companies = normalizeCompanies(editCompany.value.split(','));
d.driverID = generateDriverID(d.first, d.middle, d.last, d.license);
saveDrivers();
closeEditModal();
renderTable();
populateFilters();
applyFilters();
});

function closeEditModal() {
editingIndex = -1;
document.getElementById('editModal').classList.remove('active');
}

/* ---------------- DELETE DRIVER ---------------- */
function deleteDriver(index) {
if (!confirm('Delete this record?')) return;
drivers.splice(index, 1);
saveDrivers();
renderTable();
populateFilters();
applyFilters();
}

/* ---------------- SORT ---------------- */
document.querySelectorAll('.sort-arrows').forEach(arrows => {
arrows.addEventListener('click', () => sortTable(parseInt(arrows.dataset.column)));
});

function sortTable(col) {
const keys = ['first','middle','last','license','companies','driverID','dateEntered'];
const key = keys[col];
sortState.asc = sortState.column === key ? !sortState.asc : true;
sortState.column = key;
drivers.sort((a, b) => {
let A = key === 'companies' ? a[key].join(', ') : a[key];
let B = key === 'companies' ? b[key].join(', ') : b[key];
return sortState.asc ? A.localeCompare(B) : B.localeCompare(A);
});
renderTable();
applyFilters();
}

function updateSortArrows() {
document.querySelectorAll('.sort-arrow').forEach(arrow => {
arrow.classList.remove('active');
});
if (sortState.column !== null) {
const keys = ['first','middle','last','license','companies','driverID','dateEntered'];
const colIndex = keys.indexOf(sortState.column);
const arrows = document.querySelector(`.sort-arrows[data-column="${colIndex}"]`);
if (arrows) {
const arrowClass = sortState.asc ? 'up' : 'down';
arrows.querySelector(`.sort-arrow.${arrowClass}`).classList.add('active');
}
}
}

/* ---------------- CASCADING FILTER FUNCTIONS ---------------- */
function getVisibleDrivers() {
const firstNameVal = filterFirstName.value;
const middleNameVal = filterMiddleName.value;
const lastNameVal = filterLastName.value;
const licenseVal = filterLicense.value;
const companyVal = filterCompany.value;
const idVal = filterDriverID.value;
const dateVal = filterDate.value;
const duplicatesOnlyChecked = showDuplicatesOnly.checked;

const companyMap = {};
drivers.forEach(d => {
if (!companyMap[d.driverID]) companyMap[d.driverID] = new Set();
d.companies.forEach(c => companyMap[d.driverID].add(c));
});

return drivers.filter(d => {
let show = true;
if (duplicatesOnlyChecked && companyMap[d.driverID].size <= 1) show = false;
if (firstNameVal && d.first !== firstNameVal) show = false;
if (middleNameVal && d.middle !== middleNameVal) show = false;
if (lastNameVal && d.last !== lastNameVal) show = false;
if (licenseVal && d.license !== licenseVal) show = false;
if (companyVal && !d.companies.includes(companyVal)) show = false;
if (idVal && d.driverID !== idVal) show = false;
if (dateVal && d.dateEntered !== dateVal) show = false;
return show;
});
}

function populateFilters() {
const visibleDrivers = getVisibleDrivers();
const hasActiveFilters = filterFirstName.value || filterMiddleName.value || 
filterLastName.value || filterLicense.value || 
filterCompany.value || filterDriverID.value || 
filterDate.value || showDuplicatesOnly.checked;

// For each filter, populate with cascading results
populateSelectCascading('filterFirstName', 
visibleDrivers.map(d => d.first), 
drivers.map(d => d.first),
hasActiveFilters
);
populateSelectCascading('filterMiddleName', 
visibleDrivers.map(d => d.middle).filter(Boolean), 
drivers.map(d => d.middle).filter(Boolean),
hasActiveFilters
);
populateSelectCascading('filterLastName', 
visibleDrivers.map(d => d.last), 
drivers.map(d => d.last),
hasActiveFilters
);
populateSelectCascading('filterLicense', 
visibleDrivers.map(d => d.license), 
drivers.map(d => d.license),
hasActiveFilters
);
populateSelectCascading('filterCompany', 
visibleDrivers.flatMap(d => d.companies), 
drivers.flatMap(d => d.companies),
hasActiveFilters
);
populateSelectCascading('filterDriverID', 
visibleDrivers.map(d => d.driverID), 
drivers.map(d => d.driverID),
hasActiveFilters
);
populateSelectCascading('filterDate', 
visibleDrivers.map(d => d.dateEntered), 
drivers.map(d => d.dateEntered),
hasActiveFilters
);
}

function populateSelectCascading(id, visibleValues, allValues, showCascading) {
const select = document.getElementById(id);
const current = select.value;
select.innerHTML = '<option value="">All</option>';

if (showCascading) {
// Get unique values
const visibleUnique = [...new Set(visibleValues)].sort();
const allUnique = [...new Set(allValues)].sort();
const remaining = allUnique.filter(v => !visibleUnique.includes(v));

// Add visible (filtered) results first
if (visibleUnique.length > 0) {
const optgroup1 = document.createElement('optgroup');
optgroup1.label = '── Filtered Results ──';
visibleUnique.forEach(v => {
if (!v && v !== '') return;
const opt = document.createElement('option');
opt.value = v;
opt.textContent = v || '(blank)';
optgroup1.appendChild(opt);
});
select.appendChild(optgroup1);
}

// Add remaining unfiltered results
if (remaining.length > 0) {
const optgroup2 = document.createElement('optgroup');
optgroup2.label = '── Other Results ──';
remaining.forEach(v => {
if (!v && v !== '') return;
const opt = document.createElement('option');
opt.value = v;
opt.textContent = v || '(blank)';
optgroup2.appendChild(opt);
});
select.appendChild(optgroup2);
}
} else {
// No filters active, just show all values
const allUnique = [...new Set(allValues)].sort();
allUnique.forEach(v => {
if (!v && v !== '') return;
const opt = document.createElement('option');
opt.value = v;
opt.textContent = v || '(blank)';
select.appendChild(opt);
});
}

// Restore current value if it still exists
if (current && allValues.includes(current)) {
select.value = current;
}
}

function applyFilters() {
const visibleDrivers = getVisibleDrivers();

const companyMap = {};
drivers.forEach(d => {
if (!companyMap[d.driverID]) companyMap[d.driverID] = new Set();
d.companies.forEach(c => companyMap[d.driverID].add(c));
});

[...tbody.rows].forEach((row, i) => {
const d = drivers[i];
const isVisible = visibleDrivers.includes(d);
row.style.display = isVisible ? '' : 'none';
});

document.getElementById('recordCount').textContent = visibleDrivers.length;

// Update filter dropdowns with cascading results
populateFilters();
}

/* ---------------- RESET FILTERS ---------------- */
function resetFilters() {
filterFirstName.value = '';
filterMiddleName.value = '';
filterLastName.value = '';
filterLicense.value = '';
filterCompany.value = '';
filterDriverID.value = '';
filterDate.value = '';
showDuplicatesOnly.checked = false;

// Show all rows
[...tbody.rows].forEach(row => {
row.style.display = '';
});

document.getElementById('recordCount').textContent = drivers.length;

// Reset filters to show all options
populateFilters();
}

clearFiltersBtn.addEventListener('click', resetFilters);

/* ---------------- INIT ---------------- */
loadDrivers();
renderTable();
populateFilters();
applyFilters();
updateCompanyDropdown();

/* Filter event hookups */
[
filterFirstName, filterMiddleName, filterLastName,
filterLicense, filterCompany, filterDriverID, filterDate, showDuplicatesOnly
].forEach(sel => sel.addEventListener('change', applyFilters));

// Prevent filter dropdowns from triggering sort
document.querySelectorAll('.filter-select').forEach(select => {
select.addEventListener('click', e => e.stopPropagation());
});

</script>
</body>
</html>
